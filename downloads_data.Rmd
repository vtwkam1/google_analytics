---
title: "Google analytics"
author: "Impact team"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
        code_download: TRUE
        code_folding: "hide"
runtime: shiny
params:
    month_start: 2019-06
    month_end: 2022-06
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(DT)
library(kableExtra)
library(zoo)
library(plotly)
# library(reactable)

```

```{r, eval = FALSE}
rmarkdown::render('downloads_data.Rmd',
       output_file = paste0('./output/', params$file_regex, '_downloads_', Sys.Date(), '.html'),
       params = list(month_start = "2019-06",
                     month_end = "2022-06",
                     product = "Quality improvement resource",
                     file_regex = "quality-improvement-resource"
                     )
       )
```


```{r}
month_start <- ym(params$month_start)
month_end <- ym(params$month_end)

# Calculate number of months
months_diff <- floor((month_start %--% month_end) / dmonths(1))

# Create vector with all the relevant months
month_list <- month_start + months(0:months_diff)

# Generate file names using months specified above
filename <- map(month_list, ~ sprintf("../quality_standard/download_analytics/HSC dashboard - Engagement and implementation_All webpages_ links and downloads_Table_%s.csv", as.character(.x) %>% str_remove("-01$")))
```


```{r}
# Import data
data <- filename %>% 
    set_names() %>% 
    map_dfr(read_csv, col_types = "ccd", .id = "filename")

# Extract the date from the file name
data <- data %>% 
    mutate(year_month = str_extract(filename, "(?<=Table_)\\d{4}-\\d{2}(?=.csv)") %>% ym(.)) %>% 
    select(-filename) %>%
    rename(page_path = 'Page path',
           file = File,
           downloads = Downloads) %>% 
    select(year_month, everything())
```


```{r, eval = FALSE}
# Save master file
write_csv(data, paste0("./output/all_downloads_", params$month_start, "_", params$month_end, ".csv"))
```

```{r}
# List of products with filename regex
product_list <- list("QSSIT" = "((QS)|(quality-standard))-service-improvement-template",
                      "Baseline assessment tool (BAT)" = "baseline-assessment-tool",
                      "Resource planner" = "resource-planner"
)

```


```{r}
shinyApp(

  ui = fluidPage(
    selectInput("select_products", 
                "Select products:",
                choices = product_list,
                multiple = TRUE),
    verbatimTextOutput("input"),
    dataTableOutput("downloads_table")
  ),
  
  server = function(input, output) {
    trial <- reactive({
        data %>% 
            filter(str_detect(file, regex(str_c(input$select_products, collapse = "|"), ignore_case = TRUE)))
    })
    
    output$downloads_table = renderDataTable(trial())
  },

  options = list(height = 500)
)
```



<!-- ```{r} -->
<!-- # Save -->
<!-- # write_csv(selected, sprintf('./output/%s_%s_to_%s.csv', params$file_regex, params$month_start, params$month_end)) -->

<!-- ``` -->


<!-- ```{r} -->
<!-- # Present raw data -->
<!-- selected %>% -->
<!--     datatable(., -->
<!--           filter = "top", -->
<!--           colnames = c("Month" = "year_month", -->
<!--                        "Download page" = "page_path", -->
<!--                        "File URL" = "file", -->
<!--                        "Downloads" = "downloads"), -->
<!--           rownames = FALSE, -->
<!--           extensions = 'Buttons', -->
<!--           options = list( -->
<!--               dom = 'Bfrtip', -->
<!--               buttons = c('csv') -->
<!--   )) -->
<!-- ``` -->
<!-- # `r paste0("Monthly downloads of the ", params$product)` -->
<!-- ```{r} -->
<!-- total_downloads <- selected %>%  -->
<!--     group_by(year_month) %>%  -->
<!--     summarise(downloads = sum(downloads)) -->

<!-- total_downloads %>%  -->
<!--     mutate(year_month = zoo::as.yearmon(year_month)) %>%  -->
<!--     rename("Month" = year_month, -->
<!--            "Downloads" = downloads) %>%  -->
<!--     kbl() %>%  -->
<!--     kable_styling(bootstrap_options = c("striped", "hover")) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- fig <- total_downloads %>%  -->
<!--     mutate(year_month = zoo::as.yearmon(year_month)) %>%  -->
<!--     ggplot(aes(x = year_month, y = downloads)) + -->
<!--     geom_line() + -->
<!--     labs(x = "Month", -->
<!--          y = "Downloads", -->
<!--          title = paste0("Total monthly downloads of the ", params$product)) + -->
<!--     scale_y_continuous(expand = c(0,0), -->
<!--                        limits = c(0, NA)) -->


<!-- fig %>% ggplotly() -->
<!-- ``` -->

