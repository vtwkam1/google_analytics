---
title: "Product review: Google Analytics"
author: "Impact team"
date: "`r Sys.Date()`"
output: 
    flexdashboard::flex_dashboard:
        source_code: embed
        vertical_layout: scroll
        orientation: rows
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(fuzzyjoin)
library(DT)
# library(kableExtra)
# library(zoo)
library(plotly)
library(reactable)
```

```{r, include = FALSE}
# Specify time period GA data is available for
month_start <- ym("2019-06")
month_end <- ym("2022-06")
```


```{r, include = FALSE}
# Calculate number of months
months_diff <- floor((month_start %--% month_end) / dmonths(1))

# Create vector with all the relevant months
month_list <- month_start + months(0:months_diff)

# Generate file names using months specified above
downloads_filename <- map(month_list, ~ sprintf("./download_analytics/HSC dashboard - Engagement and implementation_All webpages_ links and downloads_Table_%s.csv", as.character(.x) %>% str_remove("-01$")))

views_filename <- map(month_list, ~ sprintf("./download_analytics/HSC dashboard - Engagement and implementation_All webpages_ links and downloads_Table_views_%s.csv", as.character(.x) %>% str_remove("-01$")))
```


```{r, include = FALSE}
# Import data
import_data <- function(filenames) {
    filenames %>%
        set_names() %>%
        map_dfr(read_csv, col_types = "ccd", .id = "filename")
}


downloads_data <- import_data(downloads_filename)

views_data <- import_data(views_filename)

```


```{r, include = FALSE}
# Extract the date from the file name
extract_date <- function(table, date_regex) {
    table %>% 
        mutate(year_month = str_extract(filename, date_regex) %>% ym(.)) %>% 
        select(-filename) %>%
        janitor::clean_names() %>%
        select(year_month, everything())
}

downloads_data <- extract_date(downloads_data, "(?<=Table_)\\d{4}-\\d{2}(?=.csv)")

views_data <- extract_date(views_data, "(?<=Table_views_)\\d{4}-\\d{2}(?=.csv)")

```

```{r, include = FALSE}
# List of products with filename regex
product_list <- list("QSSIT" = "((QS)|(quality-standard))-service-improvement-template",
                      "Baseline assessment tool" = "baseline-assessment-tool",
                      "Resource planner" = "resource-planner",
                     "Resource impact template" = "resource-impact-template",
                     "Resource impact report" = "resource-impact-report"
)

```

Inputs {.sidebar}
-------------------------------------

```{r, echo = FALSE}
selectInput("select_products", 
                "Select products:",
                choices = product_list,
                multiple = TRUE)
```


```{r, echo = FALSE}
dl_selected <- reactive({
    dl_selected <- downloads_data %>% 
            filter(str_detect(file, regex(str_c(input$select_products, collapse = "|"), ignore_case = TRUE)))
    
    product_list_tbl <- tibble(product = names(product_list), regex = product_list)

    dl_selected %>% 
        regex_inner_join(product_list_tbl,
                         by = c(file = "regex")) %>% 
        select(-regex) %>% 
        mutate(product = as_factor(product))
    })

dl_monthly <- reactive({
    dl_selected() %>% 
        group_by(product, year_month) %>% 
        summarise(monthly_downloads = sum(downloads))
})
```

Row {.tabset .tabset-fade}
-------------------------------------

### Graph of monthly downloads

```{r, echo = FALSE}
renderPlotly({
    req(input$select_products)
    
    fig <- ggplot(data = dl_monthly(),
                  aes(x = year_month, y = monthly_downloads, colour = product)) +
        geom_line() +
        labs(x = "Month",
             y = "Downloads") +
        scale_y_continuous(expand = c(0,0),
                           limits = c(0, NA)) +
        scale_x_date(date_breaks = "6 months",
                     date_labels = "%b %Y")


    ggplotly(fig)
})
```

### Table

```{r, echo = FALSE}
renderDT(dl_monthly(),
         filter = "top",
         extensions = c("Scroller", "Buttons"),
         options = list(
             scrollY = 400,
             scrollX = TRUE,
             scroller = TRUE,
             dom = "Bfrtip",
             buttons = c('copy', 'csv', 'excel')
             ),
         rownames = FALSE) 
```

Row {.tabset .tabset-fade}
-------------------------------------

### Which pages are the products most frequently downloaded from?

All pages contributing less than 5% to the monthly download of a product are collapsed into "Other".

```{r, include = FALSE}
download_page <- reactive({
    dl_selected() %>%
        group_by(product) %>% 
        mutate(downloaded_from = fct_lump_prop(page_path, w = downloads, prop = 0.05)) %>% 
        ungroup()
})
```

```{r, echo = FALSE}
renderPlotly({
    req(input$select_products)
    
    source_fig <- download_page() %>%
        group_by(product, year_month, downloaded_from) %>%
        summarise(monthly_downloads = sum(downloads)) %>%
        ggplot(aes(x = year_month,
                   y = monthly_downloads, 
                   colour = product, 
                   linetype = downloaded_from)) +
        geom_line() +
        labs(x = "Month",
             y = "Downloads") +
        scale_y_continuous(expand = c(0,0),
                           limits = c(0, NA)) +
        scale_x_date(date_breaks = "6 months",
                     date_labels = "%b %Y")


    ggplotly(source_fig)
})

```

### Table
```{r, echo = FALSE}
renderReactable({
    download_page() %>%
        select(-file) %>% 
        reactable(.,
                  filterable = TRUE,
                  searchable = TRUE,
                  groupBy = c("product", "year_month", "downloaded_from"),
                  columns = list(
                      downloads = colDef(aggregate = "sum")
                      )
                  )
})

```

Row
-------------------------------------

### Raw downloads data showing page downloaded from and file download URL

```{r, echo = FALSE}
renderDT(dl_selected() %>% select(product, everything()),
         filter = "top",
         extensions = c("Scroller", "Buttons"),
         options = list(
             scrollY = 400,
             scrollX = TRUE,
             scroller = TRUE,
             dom = "Bfrtip",
             buttons = c('copy', 'csv', 'excel')
             ),
         rownames = FALSE) 
```
