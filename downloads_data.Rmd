---
title: "Google analytics"
author: "Impact team"
date: "`r Sys.Date()`"
output: 
    flexdashboard::flex_dashboard:
        source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(fuzzyjoin)
library(DT)
library(kableExtra)
library(zoo)
library(plotly)
# library(reactable)

```

```{r, include = FALSE}
# Specify time period GA data is available for
month_start <- ym("2019-06")
month_end <- ym("2022-06")
```


```{r, include = FALSE}
# Calculate number of months
months_diff <- floor((month_start %--% month_end) / dmonths(1))

# Create vector with all the relevant months
month_list <- month_start + months(0:months_diff)

# Generate file names using months specified above
filename <- map(month_list, ~ sprintf("../quality_standard/download_analytics/HSC dashboard - Engagement and implementation_All webpages_ links and downloads_Table_%s.csv", as.character(.x) %>% str_remove("-01$")))
```


```{r, include = FALSE}
# Import data
data <- filename %>% 
    set_names() %>% 
    map_dfr(read_csv, col_types = "ccd", .id = "filename")
```


```{r, include = FALSE}
# Extract the date from the file name
data <- data %>% 
    mutate(year_month = str_extract(filename, "(?<=Table_)\\d{4}-\\d{2}(?=.csv)") %>% ym(.)) %>% 
    select(-filename) %>%
    rename(page_path = 'Page path',
           file = File,
           downloads = Downloads) %>% 
    select(year_month, everything())
```

```{r, include = FALSE}
# List of products with filename regex
product_list <- list("QSSIT" = "((QS)|(quality-standard))-service-improvement-template",
                      "Baseline assessment tool (BAT)" = "baseline-assessment-tool",
                      "Resource planner" = "resource-planner"
)

```

Sidebar {.sidebar}
=====================================

```{r, echo = FALSE}
selectInput("select_products", 
                "Select products:",
                choices = product_list,
                multiple = TRUE)
```

Graph
=====================================

```{r, echo = FALSE}
selected <- reactive({
    selected <- data %>% 
            filter(str_detect(file, regex(str_c(input$select_products, collapse = "|"), ignore_case = TRUE)))
    
    product_list_tbl <- tibble(product = names(product_list), regex = product_list)

    selected %>% 
        regex_inner_join(product_list_tbl,
                         by = c(file = "regex"))
    })
```

```{r, include = FALSE}

selected <- data %>% 
    filter(str_detect(file, regex(str_c(product_list, collapse = "|"), ignore_case = TRUE))) %>% 
    select(year_month, everything())

product_list_tbl <- tibble(product = names(product_list), regex = product_list)

selected %>% 
    regex_inner_join(product_list_tbl,
                     by = c(file = "regex"))

selected %>%
    datatable(.,
          filter = "top",
          colnames = c("Month" = "year_month",
                       "Download page" = "page_path",
                       "File URL" = "file",
                       "Downloads" = "downloads"),
          rownames = FALSE,
          extensions = 'Buttons',
          options = list(
              dom = 'Bfrtip',
              buttons = c('csv')
  ))

```

Raw data
=====================================

### Raw downloads data from all NICE webpages

```{r, echo = FALSE}
renderDataTable(selected())
```
